# 数据库请求规范

## 连接池规范

### MySQL 连接池
- 最大连接数：根据应用服务器数量和数据库性能设置，建议 50-200
- 最小空闲连接数：建议为最大连接数的 20%-30%
- 连接最大生命周期：建议 30 分钟
- 连接最大空闲时间：建议 10 分钟
- 连接获取超时：建议 5 秒
- 连接验证查询：使用 `SELECT 1` 或 `SELECT 1 FROM DUAL`

### MongoDB 连接池
- 最大连接数：建议 100
- 最小连接数：建议 10
- 连接最大空闲时间：建议 5 分钟
- 连接最大生命周期：建议 30 分钟
- 连接获取超时：建议 5 秒
- 连接验证：启用连接验证

### Redis 连接池
- 最大连接数：建议 50-100
- 最小空闲连接数：建议 10
- 连接最大空闲时间：建议 5 分钟
- 连接最大生命周期：建议 30 分钟
- 连接获取超时：建议 3 秒
- 连接验证：使用 PING 命令验证

## 超时时间设置

### MySQL 超时
- 连接超时：建议 5 秒
- 读取超时：建议 10 秒
- 写入超时：建议 10 秒
- 查询超时：建议 30 秒
- 事务超时：建议 60 秒

### MongoDB 超时
- 连接超时：建议 5 秒
- 读取超时：建议 10 秒
- 写入超时：建议 10 秒
- 查询超时：建议 30 秒
- 事务超时：建议 60 秒

### Redis 超时
- 连接超时：建议 3 秒
- 读取超时：建议 5 秒
- 写入超时：建议 5 秒
- 命令超时：建议 10 秒

## 查询规范

### MySQL 查询
- 避免使用 `SELECT *`，明确指定查询字段
- 查询字段数量不超过 20 个
- 使用 `LIMIT` 限制返回结果数量
- 避免在 `WHERE` 子句中使用函数
- 为查询条件字段创建索引
- 避免全表扫描

### MongoDB 查询
- 明确指定返回字段（projection）
- 使用 `limit()` 限制返回结果数量
- 为查询条件字段创建索引
- 避免全集合扫描
- 避免使用 `$where` 查询

### Redis 查询
- 使用合适的数据结构
- 避免使用 `KEYS *` 命令
- 使用 `SCAN` 命令遍历键
- 使用管道批量执行命令
- 使用 Lua 脚本执行复杂操作

## 连表查询规范

### 原则
- 原则上不建议使用连表查询
- 优先使用应用层组装数据
- 避免复杂的连表查询

### 连表查询条件
如果确实需要连表查询，必须满足以下条件之一：
1. 需要同时关联多个表的数据进行聚合统计
2. 业务逻辑强相关，无法拆分为多次查询
3. 性能测试证明连表查询优于多次查询
4. 数据量较小，连表查询性能影响可接受

### 连表查询注释
- 连表查询必须在注释中严格注明连表查询原因
- 注释格式：`-- 连表查询原因：{具体原因说明}`
- 注释应详细说明为什么必须使用连表查询
- 注释应包含性能测试结果（如果适用）

### 连表查询限制
- JOIN 表数量不超过 3 个
- 为 JOIN 字段创建索引
- 使用小表驱动大表
- 避免在 ON 子句中使用函数

## 批量操作规范

### MySQL 批量操作
- 使用批量 `INSERT` 插入数据
- 单次批量插入记录数不超过 1000 条
- 使用批量 `UPDATE` 更新数据
- 单次批量更新记录数不超过 500 条
- 使用批量 `DELETE` 删除数据
- 单次批量删除记录数不超过 500 条

### MongoDB 批量操作
- 使用 `bulkWrite()` 批量操作
- 单次批量操作不超过 1000 条
- 使用有序批量操作（ordered: true）
- 使用无序批量操作（ordered: false）提高性能

### Redis 批量操作
- 使用管道批量执行命令
- 单次管道命令数量不超过 100 条
- 使用 `MGET`、`MSET` 批量读写
- 使用 Lua 脚本执行批量操作

## 事务规范

### MySQL 事务
- 明确事务的边界
- 事务尽可能短
- 避免在事务中执行耗时操作
- 避免在事务中调用外部服务
- 设置合理的事务隔离级别
- 使用 `ROLLBACK` 处理错误

### MongoDB 事务
- 明确事务的边界
- 事务尽可能短
- 避免在事务中执行耗时操作
- 避免在事务中调用外部服务
- 事务必须在 60 秒内完成
- 事务涉及的集合必须在同一个分片上

### Redis 事务
- 使用 `MULTI`、`EXEC` 执行事务
- 事务尽可能短
- 避免在事务中执行耗时操作
- 使用 `WATCH` 实现乐观锁
- 使用 `DISCARD` 取消事务

## 错误处理

### MySQL 错误处理
- 检查所有数据库操作的错误
- 记录错误日志
- 提供有用的错误信息
- 实现重试机制
- 重试次数不超过 3 次
- 重试间隔指数退避

### MongoDB 错误处理
- 检查所有数据库操作的错误
- 记录错误日志
- 提供有用的错误信息
- 实现重试机制
- 重试次数不超过 3 次
- 重试间隔指数退避

### Redis 错误处理
- 检查所有数据库操作的错误
- 记录错误日志
- 提供有用的错误信息
- 实现重试机制
- 重试次数不超过 3 次
- 重试间隔指数退避

## 性能优化

### MySQL 性能优化
- 使用索引优化查询
- 使用覆盖索引减少回表
- 使用 `EXPLAIN` 分析查询计划
- 优化子查询为 JOIN
- 使用分页查询
- 使用读写分离

### MongoDB 性能优化
- 使用索引优化查询
- 使用覆盖索引减少回表
- 使用 `explain()` 分析查询计划
- 优化聚合管道
- 使用分页查询
- 使用读写分离

### Redis 性能优化
- 使用合适的数据结构
- 使用管道批量执行命令
- 使用 Lua 脚本执行复杂操作
- 使用缓存热点数据
- 使用集群扩展性能

## 安全规范

### SQL 注入防护
- 使用参数化查询
- 避免拼接 SQL 语句
- 对用户输入进行验证和过滤
- 使用 ORM 框架

### NoSQL 注入防护
- 使用参数化查询
- 避免拼接查询语句
- 对用户输入进行验证和过滤
- 使用 ORM 框架

### 权限控制
- 遵循最小权限原则
- 应用程序使用专用数据库账号
- 禁止使用 root 账号
- 定期更新密码

### 敏感信息
- 密码等敏感信息加密存储
- 使用单向加密（如 bcrypt）
- 不在日志中记录敏感信息
- 不在错误信息中暴露敏感信息

## 监控和日志

### 性能监控
- 监控慢查询
- 监控连接数
- 监控查询响应时间
- 监控数据库负载
- 监控磁盘空间
- 监控内存使用

### 日志记录
- 记录所有数据库操作
- 记录查询参数
- 记录查询结果
- 记录错误信息
- 记录执行时间
- 不记录敏感信息

### 告警
- 设置慢查询告警
- 设置连接数告警
- 设置错误率告警
- 设置响应时间告警
- 设置磁盘空间告警
- 设置内存使用告警

## 最佳实践

### 连接管理
- 使用连接池
- 及时释放连接
- 设置合理的连接超时
- 设置合理的连接池大小

### 查询优化
- 使用索引
- 避免全表扫描
- 使用分页查询
- 使用批量操作
- 使用缓存

### 事务管理
- 事务尽可能短
- 及时提交或回滚
- 避免长事务
- 设置合理的事务隔离级别

### 错误处理
- 及时处理错误
- 提供有用的错误信息
- 实现重试机制
- 记录错误日志

## 禁止事项

### MySQL 禁止事项
- 禁止在生产环境执行 DDL 语句
- 禁止在生产环境执行无 WHERE 条件的 UPDATE 和 DELETE
- 禁止使用存储过程和触发器（特殊情况除外）
- 禁止使用外键约束（应用层保证数据一致性）
- 禁止使用大字段（BLOB、TEXT）作为主键
- 禁止在索引列上使用函数
- 禁止使用 `SELECT *`
- 禁止使用隐式类型转换
- 禁止使用连表查询（特殊情况除外）

### MongoDB 禁止事项
- 禁止在生产环境执行危险的删除操作
- 禁止在生产环境执行无条件的 updateMany() 和 deleteMany()
- 禁止使用 `$where` 查询
- 禁止使用大文档（超过 16MB）
- 禁止在索引列上使用函数
- 禁止使用正则表达式的左锚定
- 禁止在事务中执行耗时操作
- 禁止在事务中创建集合
- 禁止在事务中写入 capped 集合
- 禁止使用隐式类型转换

### Redis 禁止事项
- 禁止使用 `KEYS *` 命令
- 禁止在生产环境执行 `FLUSHALL` 和 `FLUSHDB`
- 禁止使用大 key（超过 1MB）
- 禁止使用大 value（超过 10MB）
- 禁止使用阻塞命令（BLPOP、BRPOP）
- 禁止使用 Lua 脚本执行耗时操作
- 禁止使用 O(N) 复杂度的命令处理大数据集
- 禁止使用 SCAN 遍历整个数据库
