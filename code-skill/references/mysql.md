# MySQL SQL 规范

## 命名规范

### 数据库命名
- 使用小写字母
- 单词间用下划线分隔
- 数据库名应具有描述性
- 避免使用保留字
- 长度不超过 32 个字符

### 表命名
- 使用小写字母
- 单词间用下划线分隔
- 表名应为名词复数形式
- 表名应清晰表达其内容
- 避免使用保留字
- 长度不超过 64 个字符

### 字段命名
- 使用小写字母
- 单词间用下划线分隔
- 字段名应为名词单数形式
- 布尔字段以 `is_`、`has_`、`can_` 等前缀开头
- 时间字段以 `_at`、`_time`、`_date` 等后缀结尾
- 避免使用保留字
- 长度不超过 64 个字符

### 索引命名
- 主键索引：`pk_表名`
- 唯一索引：`uk_表名_字段名`
- 普通索引：`idx_表名_字段名`
- 全文索引：`ft_表名_字段名`

### 外键命名
- `fk_表名_关联表名_字段名`

## 表设计规范

### 主键设计
- 每个表必须有主键
- 优先使用自增整数主键
- 分布式场景使用雪花算法生成 ID
- 避免使用 UUID 作为主键（性能问题）

### 字段类型选择
- 整数类型：根据数据范围选择 TINYINT、SMALLINT、INT、BIGINT
- 小数类型：金额使用 DECIMAL，避免使用 FLOAT 和 DOUBLE
- 字符串类型：固定长度使用 CHAR，可变长度使用 VARCHAR
- 文本类型：大文本使用 TEXT，避免使用 LONGTEXT
- 时间类型：使用 DATETIME 或 TIMESTAMP，避免使用字符串存储时间
- 布尔类型：使用 TINYINT(1) 表示布尔值

### 字段约束
- 必填字段设置 NOT NULL
- 字符串字段设置合理的长度限制
- 枚举类型使用 ENUM 或 TINYINT
- 设置默认值，避免使用 NULL 作为默认值

### 字段顺序
- 主键字段放在最前面
- 外键字段放在相关字段后面
- 常用查询字段放在前面
- 大字段放在最后

### 表分区
- 大表考虑分区策略
- 按时间、范围或列表分区
- 分区数量不宜过多

## 索引规范

### 索引选择
- 为 WHERE、ORDER BY、GROUP BY 的字段创建索引
- 为 JOIN 的关联字段创建索引
- 区分度高的字段优先创建索引
- 避免为低区分度的字段创建索引（如性别、状态）

### 联合索引
- 遵循最左前缀原则
- 将区分度高的字段放在前面
- 将常用查询条件的字段放在前面
- 联合索引字段数量不超过 5 个

### 索引数量
- 单表索引数量不超过 5 个
- 避免冗余索引
- 定期检查未使用的索引

### 索引优化
- 使用覆盖索引减少回表
- 避免索引失效（函数、类型转换、LIKE 前缀通配符）
- 定期分析索引使用情况

## SQL 编写规范

### SELECT 语句
- 避免使用 `SELECT *`，明确指定查询字段
- 查询字段数量不超过 20 个
- 使用 LIMIT 限制返回结果数量
- 避免在 WHERE 子句中使用函数

### WHERE 子句
- 使用索引字段作为条件
- 避免使用 OR，使用 UNION ALL 替代
- 避免使用 `!=`、`<>`、`NOT IN` 等否定条件
- 避免使用 LIKE 的前缀通配符
- 避免使用 NULL 判断

### JOIN 规范
- 避免多表 JOIN，JOIN 表数量不超过 3 个
- 为 JOIN 字段创建索引
- 使用小表驱动大表
- 避免在 ON 子句中使用函数

### 连表查询规范
- 原则上不建议使用连表查询
- 如果确实需要连表查询，必须在注释中严格注明连表查询原因
- 注释格式：`-- 连表查询原因：{具体原因说明}`
- 连表查询原因包括但不限于：
  - 需要同时关联多个表的数据进行聚合统计
  - 业务逻辑强相关，无法拆分为多次查询
  - 性能测试证明连表查询优于多次查询
  - 数据量较小，连表查询性能影响可接受

### ORDER BY 规范
- 使用索引字段排序
- 避免使用文件排序
- 避免使用表达式排序

### GROUP BY 规范
- GROUP BY 字段数量不超过 3 个
- 使用索引字段分组
- 避免使用 HAVING，使用 WHERE 过滤

### 子查询规范
- 避免使用子查询，使用 JOIN 替代
- 避免使用相关子查询
- 子查询结果集应限制数量

### INSERT 语句
- 批量插入使用批量 INSERT
- 单次插入记录数不超过 1000 条
- 明确指定插入字段
- 使用事务保证数据一致性

### UPDATE 语句
- 使用 WHERE 条件限制更新范围
- 避免全表更新
- 更新前检查影响行数

### DELETE 语句
- 使用 WHERE 条件限制删除范围
- 避免全表删除
- 删除前检查影响行数
- 大数据量删除分批执行

## 事务规范

### 事务使用
- 明确事务的边界
- 事务尽可能短
- 避免在事务中执行耗时操作
- 避免在事务中调用外部服务

### 事务隔离级别
- 默认使用 READ COMMITTED
- 根据业务需求选择合适的隔离级别
- 避免使用 SERIALIZABLE

### 死锁预防
- 按固定顺序访问表
- 尽量缩短事务时间
- 及时提交或回滚事务
- 设置合理的锁等待超时

## 性能优化

### 查询优化
- 使用 EXPLAIN 分析查询计划
- 避免全表扫描
- 使用覆盖索引
- 优化子查询为 JOIN

### 分页查询
- 使用 LIMIT 和 OFFSET 分页
- 大偏移量分页使用游标分页
- 避免深度分页

### 批量操作
- 使用批量插入、更新、删除
- 单次批量操作不超过 1000 条
- 大批量操作分批执行

### 缓存使用
- 热点数据使用缓存
- 设置合理的缓存过期时间
- 缓存穿透、击穿、雪崩防护

## 安全规范

### SQL 注入防护
- 使用参数化查询
- 避免拼接 SQL 语句
- 对用户输入进行验证和过滤

### 权限控制
- 遵循最小权限原则
- 应用程序使用专用数据库账号
- 禁止使用 root 账号

### 敏感信息
- 密码等敏感信息加密存储
- 使用单向加密（如 bcrypt）
- 不在日志中记录敏感信息

### 数据备份
- 定期备份数据
- 验证备份的可用性
- 制定恢复预案

## 维护规范

### 表结构变更
- 使用 DDL 语句变更表结构
- 大表变更在低峰期执行
- 变更前备份数据
- 测试环境验证变更

### 索引维护
- 定期分析索引使用情况
- 删除未使用的索引
- 重建碎片化严重的索引

### 数据清理
- 定期清理过期数据
- 大数据量删除分批执行
- 清理前备份数据

### 监控告警
- 监控慢查询
- 监控连接数
- 监控磁盘空间
- 设置合理的告警阈值

## 最佳实践

### 读写分离
- 主库负责写操作
- 从库负责读操作
- 使用中间件实现读写分离

### 分库分表
- 大表考虑分库分表
- 水平分表按业务规则拆分
- 垂直分表按业务模块拆分

### 数据归档
- 历史数据定期归档
- 归档数据存储到归档库
- 归档策略根据业务需求制定

### 版本控制
- 使用版本控制管理 SQL 脚本
- SQL 脚本命名规范
- 记录变更历史

## 禁止事项

- 禁止在生产环境执行 DDL 语句
- 禁止在生产环境执行无 WHERE 条件的 UPDATE 和 DELETE
- 禁止使用存储过程和触发器（特殊情况除外）
- 禁止使用外键约束（应用层保证数据一致性）
- 禁止使用大字段（BLOB、TEXT）作为主键
- 禁止在索引列上使用函数
- 禁止使用 SELECT *
- 禁止使用隐式类型转换
