# MongoDB NoSQL 规范

## 命名规范

### 数据库命名
- 使用小写字母
- 单词间用下划线分隔
- 数据库名应具有描述性
- 避免使用保留字
- 长度不超过 64 个字符

### 集合命名
- 使用小写字母
- 单词间用下划线分隔
- 集合名应为名词复数形式
- 集合名应清晰表达其内容
- 避免使用保留字
- 长度不超过 64 个字符

### 字段命名
- 使用驼峰命名法（camelCase）
- 字段名应为名词单数形式
- 布尔字段以 `is`、`has`、`can` 等前缀开头
- 时间字段以 `At`、`Time`、`Date` 等后缀结尾
- 避免使用 `$` 开头的字段名
- 避免使用 `.` 在字段名中
- 长度不超过 64 个字符

### 索引命名
- 单字段索引：`字段名_1` 或 `字段名_-1`
- 复合索引：`字段1_1_字段2_-1`
- 文本索引：`字段名_text`
- 地理空间索引：`字段名_2dsphere`

## 集合设计规范

### 文档结构
- 每个文档必须有 `_id` 字段
- 使用 ObjectId 作为默认 `_id` 类型
- 文档大小不超过 16MB
- 嵌套层级不超过 3 层

### 字段类型选择
- 整数：根据范围选择 Int32 或 Int64
- 小数：使用 Decimal128，避免使用 Double
- 字符串：使用 String
- 布尔：使用 Boolean
- 时间：使用 Date 或 Timestamp
- 数组：使用 Array
- 对象：使用 Object（嵌套文档）
- 二进制：使用 BinData

### 字段约束
- 必填字段在应用层验证
- 字符串字段设置合理的长度限制
- 枚举类型使用字符串或整数
- 设置默认值，避免使用 null 作为默认值

### 字段顺序
- `_id` 字段放在最前面
- 常用查询字段放在前面
- 大字段放在最后

### 分片策略
- 大集合考虑分片策略
- 选择合适的分片键
- 避免使用单调递增的分片键
- 分片键应具有高基数

## 索引规范

### 索引选择
- 为查询条件字段创建索引
- 为排序字段创建索引
- 为聚合管道字段创建索引
- 区分度高的字段优先创建索引
- 避免为低区分度的字段创建索引

### 复合索引
- 遵循 ESR 规则（Equality、Sort、Range）
- 将等值查询字段放在前面
- 将排序字段放在中间
- 将范围查询字段放在后面
- 复合索引字段数量不超过 5 个

### 索引数量
- 单集合索引数量不超过 5 个
- 避免冗余索引
- 定期检查未使用的索引

### 索引优化
- 使用覆盖索引减少回表
- 避免索引失效（$ne、$nin、$not、$exists）
- 定期分析索引使用情况

### 文本索引
- 为全文搜索字段创建文本索引
- 设置合理的权重
- 使用文本索引进行全文搜索

### 地理空间索引
- 为地理位置字段创建 2dsphere 索引
- 使用地理空间查询

## 查询规范

### 查询操作
- 使用 find() 查询文档
- 使用 findOne() 查询单个文档
- 使用 limit() 限制返回结果数量
- 使用 skip() 跳过指定数量的文档
- 使用 sort() 对结果排序

### 查询条件
- 使用索引字段作为查询条件
- 避免使用 $ne、$nin、$not、$exists 等否定条件
- 避免使用 $or，使用 $in 替代
- 避免使用正则表达式的前缀通配符
- 避免使用 $where 查询

### 投影
- 明确指定返回字段
- 避免返回大字段
- 使用投影减少数据传输

### 聚合管道
- 使用聚合管道进行复杂查询
- 优化聚合管道顺序
- 使用 $match 尽早过滤数据
- 使用 $project 减少数据传输
- 使用 $limit 限制结果数量

### 连表查询规范
- 原则上不建议使用 $lookup 进行连表查询
- 如果确实需要连表查询，必须在注释中严格注明连表查询原因
- 注释格式：`// 连表查询原因：{具体原因说明}`
- 连表查询原因包括但不限于：
  - 需要同时关联多个集合的数据进行聚合统计
  - 业务逻辑强相关，无法拆分为多次查询
  - 性能测试证明连表查询优于多次查询
  - 数据量较小，连表查询性能影响可接受

### 更新操作
- 使用 updateOne() 更新单个文档
- 使用 updateMany() 更新多个文档
- 使用 $set 更新字段
- 使用 $unset 删除字段
- 使用 $inc 增加数值
- 使用 $push 添加数组元素
- 使用 $pull 删除数组元素

### 删除操作
- 使用 deleteOne() 删除单个文档
- 使用 deleteMany() 删除多个文档
- 使用查询条件限制删除范围
- 避免全集合删除
- 大数据量删除分批执行

## 事务规范

### 事务使用
- 明确事务的边界
- 事务尽可能短
- 避免在事务中执行耗时操作
- 避免在事务中调用外部服务

### 事务隔离级别
- MongoDB 使用快照隔离
- 事务期间读取的数据是一致的
- 事务提交后数据才对其他事务可见

### 事务限制
- 事务必须在 60 秒内完成
- 事务涉及的集合必须在同一个分片上
- 事务不能创建集合
- 事务不能写入 capped 集合

### 重试机制
- 实现事务重试机制
- 重试次数不超过 3 次
- 重试间隔指数退避

## 性能优化

### 查询优化
- 使用 explain() 分析查询计划
- 避免全集合扫描
- 使用覆盖索引
- 优化聚合管道

### 分页查询
- 使用 limit() 和 skip() 分页
- 大偏移量分页使用游标分页
- 避免深度分页

### 批量操作
- 使用 bulkWrite() 批量操作
- 单次批量操作不超过 1000 条
- 大批量操作分批执行

### 缓存使用
- 热点数据使用缓存
- 设置合理的缓存过期时间
- 缓存穿透、击穿、雪崩防护

### 连接池
- 配置合理的连接池大小
- 设置合理的连接超时时间
- 监控连接池使用情况

## 安全规范

### 认证和授权
- 启用认证机制
- 使用角色权限控制
- 遵循最小权限原则
- 定期更新密码

### 网络安全
- 使用 TLS 加密连接
- 限制访问 IP
- 使用防火墙保护数据库

### 数据加密
- 敏感字段加密存储
- 使用 MongoDB 的字段级加密
- 密钥管理规范

### 注入防护
- 使用参数化查询
- 避免拼接查询语句
- 对用户输入进行验证和过滤

### 审计日志
- 启用审计日志
- 记录关键操作
- 定期审计日志

### 数据备份
- 定期备份数据
- 使用 MongoDB 的备份工具
- 验证备份的可用性
- 制定恢复预案

## 维护规范

### 集合变更
- 大集合变更在低峰期执行
- 变更前备份数据
- 测试环境验证变更

### 索引维护
- 定期分析索引使用情况
- 删除未使用的索引
- 重建碎片化严重的索引

### 数据清理
- 定期清理过期数据
- 大数据量删除分批执行
- 清理前备份数据

### 监控告警
- 监控慢查询
- 监控连接数
- 监控磁盘空间
- 监控内存使用
- 设置合理的告警阈值

### 版本升级
- 升级前备份数据
- 测试环境验证升级
- 选择合适的升级时机
- 准备回滚方案

## 最佳实践

### 读写分离
- 主节点负责写操作
- 从节点负责读操作
- 使用读写分离提高性能

### 分片集群
- 大数据量使用分片集群
- 选择合适的分片键
- 均衡数据分布
- 监控分片状态

### 数据归档
- 历史数据定期归档
- 归档数据存储到归档集合
- 归档策略根据业务需求制定

### TTL 索引
- 使用 TTL 索引自动删除过期数据
- 设置合理的过期时间
- 监控 TTL 索引执行情况

### Change Streams
- 使用 Change Streams 监听数据变化
- 实现实时数据处理
- 设置合理的恢复令牌

### 版本控制
- 使用版本控制管理变更脚本
- 变更脚本命名规范
- 记录变更历史

## 禁止事项

- 禁止在生产环境执行危险的删除操作
- 禁止在生产环境执行无条件的 updateMany() 和 deleteMany()
- 禁止使用 $where 查询
- 禁止使用大文档（超过 16MB）
- 禁止在索引列上使用函数
- 禁止使用正则表达式的左锚定
- 禁止在事务中执行耗时操作
- 禁止在事务中创建集合
- 禁止在事务中写入 capped 集合
- 禁止使用隐式类型转换
